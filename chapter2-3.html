<!DOCTYPE HTML>
<html lang="fr" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Wasm sans le navigateur - PrÃ©sentations et Ã©tudes sur wasm</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="chapter1-0.html"><strong aria-hidden="true">1.</strong> wasm en 5 minutes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter1-1.html"><strong aria-hidden="true">1.1.</strong> Il Ã©tait une fois Wasm</a></li><li class="chapter-item expanded "><a href="chapter1-2.html"><strong aria-hidden="true">1.2.</strong> Comment Ã§a fonctionne ?</a></li><li class="chapter-item expanded "><a href="chapter1-3.html"><strong aria-hidden="true">1.3.</strong> Ã‡a complexifie le dev web, pourquoi on devrait s'embÃªter ?</a></li><li class="chapter-item expanded "><a href="chapter1-4.html"><strong aria-hidden="true">1.4.</strong> Vers l'infini et au-delÃ </a></li><li class="chapter-item expanded "><a href="chapter1-5.html"><strong aria-hidden="true">1.5.</strong> Wasm : c'est le turfu ou encore un truc de hipster ?</a></li></ol></li><li class="chapter-item expanded "><a href="chapter2-0.html"><strong aria-hidden="true">2.</strong> wasm 101</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter2-1.html"><strong aria-hidden="true">2.1.</strong> Rust+Wasm</a></li><li class="chapter-item expanded "><a href="chapter2-2.html"><strong aria-hidden="true">2.2.</strong> Les outils Rust+Wasm</a></li><li class="chapter-item expanded "><a href="chapter2-3.html" class="active"><strong aria-hidden="true">2.3.</strong> Wasm sans le navigateur</a></li><li class="chapter-item expanded "><a href="chapter2-4.html"><strong aria-hidden="true">2.4.</strong> SynthÃ¨se sur l'outillage</a></li></ol></li><li class="chapter-item expanded "><a href="bibliographie.html">Liens et sources</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">PrÃ©sentations et Ã©tudes sur wasm</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="wasm-sans-le-navigateur"><a class="header" href="#wasm-sans-le-navigateur">Wasm sans le navigateur</a></h2>
<p>AprÃ¨s avoir vu comment Ã©crire et utiliser des modules wasm dans le navigateur, avec et sans outillage, il est temps de
voir toutes les potentialitÃ©s de wasm. Parce que wasm est une stack-based virtual machine et peut donc s'interfacer avec
n'importe quel matÃ©riel et n'importe quel OS pour peu que ce dernier embarque un wasm runtime.</p>
<h3 id="wasm-runtime"><a class="header" href="#wasm-runtime">Wasm runtime</a></h3>
<p>AprÃ¨s avoir compilÃ© un module wasm vers un binaire wasm, il faut que la machine hÃ´te puisse exÃ©cuter ce binaire et donc
comprendre les instructions qui lui sont passÃ©es. Un des points fort de Wasm est la portabilitÃ©. Cela signifie que
l'exÃ©cution d'un binaire wasm aura un rÃ©sultat prÃ©dictible peu importe l'OS sur lequel il est exÃ©cutÃ©.</p>
<p>Mais pour arriver Ã  ce rÃ©sultat, il faut bien un outil (runtime) qui est capable de comprendre les instructions
contenues dans le binaire et de faire le lien avec les fonctions natives de l'OS. Par exemple, lire un stream, charger
un buffer en mÃ©moire, donner accÃ¨s au filesystem. La liste est longue.</p>
<p>Voici une liste non exhaustive des runtimes pour WebAssembly qui existent :</p>
<ul>
<li>wasmer</li>
<li>wasmtime</li>
<li>lucet</li>
<li>WAMR - WebAssembly Micro Runtime</li>
</ul>
<p>Pour l'exemple de code, nous allons utiliser wasmer.</p>
<h3 id="wasi"><a class="header" href="#wasi">WASI</a></h3>
<p>Avant d'installer wasmer et d'exÃ©cuter notre module wasm, quelques prÃ©cisions sur WASI.</p>
<p>Dans le prÃ©cÃ©dent paragraphe, il Ã©tait question du runtime et de sa capacitÃ© Ã  faire le lien entre le binaire wasm et
les fonctions natives de l'OS. Pour que cela fonctionne sur la multitude d'OS et de hardware qui existe aujourd'hui, il
faut un system interface, c'est-Ã -dire une API, qui expose la faÃ§on dont l'OS accÃ¨de, par exemple, Ã  la hiÃ©rarchie du
filesystem.</p>
<p>WASI est une initiative pour standardiser la faÃ§on dont les runtimes s'interfacent avec les OS, pour garantir une
portabilitÃ© gÃ©nÃ©rique et assurer de la stabilitÃ© pour les outils qui s'appuient sur les runtimes wasm.</p>
<h3 id="exemple-avec-du-code"><a class="header" href="#exemple-avec-du-code">Exemple avec du code</a></h3>
<p>Enfin ! Nous allons pouvoir lancer un programme Ã©crit en rust, compilÃ© en binaire wasm et exÃ©cuter par wasmer(wasm
runtime) sur une machine sans passer par le navigateur.</p>
<h4 id="-prÃ©requis-"><a class="header" href="#-prÃ©requis-">ğŸ› ï¸ PrÃ©requis ğŸ› ï¸</a></h4>
<ul>
<li>Avoir installÃ© <a href="https://github.com/wasmerio/wasmer#install">wasmer</a></li>
<li>Avoir ajoutÃ© la target wasm32-wasi aves rustup, si ce n'est pas dÃ©jÃ  fait, lancer la
commande <code>rustup target add wasm32-wasi</code> dans un terminal</li>
</ul>
<h4 id="-coder-le-projet-"><a class="header" href="#-coder-le-projet-">ğŸš§ Coder le projet ğŸš§</a></h4>
<p>Lancer la commande <code>cargo new simple-example-with-wasmer</code>. Cela crÃ©er le projet, cette fois, il ne s'agit pas d'une lib
rust mais d'un exÃ©cutable. Le point d'entrÃ© est le fichier <code>main</code> et la fonction <code>main</code> va Ãªtre exportÃ©e par dÃ©faut dans
la target wasm.</p>
<p>Dans le fichier <code>scr/main.rs</code> ajouter le code suivant :</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    println!(&quot;What's ye name?&quot;);
    let mut buffer = String::from(&quot;&quot;);
    let stdin = std::io::stdin();
    stdin.read_line(&amp;mut buffer);
    println!(&quot;Ho hi, {}!&quot;, buffer.trim());
}
</code></pre></pre>
<p>My, my! C'est du code Rust, pas de macro pour interagir avec le runtime wasm. On se sent comme Ã  la maison, en
charentaises et en peignoir au coin du feu.</p>
<p>Pas de spÃ©cificitÃ© dans le <code>Cargo.toml</code> non plus :</p>
<pre><code class="language-toml">[package]
name = &quot;simple-example-with-wasmer&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[dependencies]
</code></pre>
<p>Il ne reste plus qu'Ã  compiler le code rust vers la cible wasm-wasi :
<code>cargo build --target wasm32-wasi --release</code>
On retrouve le binaire produit dans le dossier <code>target</code></p>
<pre><code class="language-text">.
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ README.md
â”œâ”€â”€ src
â”‚  â””â”€â”€ main.rs
â””â”€â”€ target
   â”œâ”€â”€ CACHEDIR.TAG
   â”œâ”€â”€ release
   â”‚  â”œâ”€â”€ build
   â”‚  â”œâ”€â”€ deps
   â”‚  â”œâ”€â”€ examples
   â”‚  â””â”€â”€ incremental
   â””â”€â”€ wasm32-wasi
      â”œâ”€â”€ CACHEDIR.TAG
      â””â”€â”€ release
         â”œâ”€â”€ build
         â”œâ”€â”€ deps
         â”‚  â”œâ”€â”€ simple_example_with_wasmer-11e993127ad92e3a.d
         â”‚  â””â”€â”€ simple_example_with_wasmer-11e993127ad92e3a.wasm
         â”œâ”€â”€ examples
         â”œâ”€â”€ incremental
         â”œâ”€â”€ simple-example-with-wasmer.d
         â””â”€â”€ simple-example-with-wasmer.wasm &lt;-- le binaire wasm est ici !
</code></pre>
<h4 id="-show-time-"><a class="header" href="#-show-time-">ğŸ™Œ Show time ğŸ™Œ</a></h4>
<p>Lorsque la commande <code>wasmer run target/wasm32-wasi/release/simple-example-with-wasmer.wasm</code> le runtime wasm exÃ©cute le
programme. Et c'est fait ğŸ‰. On a notre premier programme compilÃ© en wasm qui peut s'exÃ©cuter sur n'importe quelle
machine qui embarque un runtime wasm.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter2-2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="chapter2-4.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter2-2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="chapter2-4.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
